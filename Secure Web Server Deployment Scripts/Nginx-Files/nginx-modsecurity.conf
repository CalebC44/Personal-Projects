# fail2ban filter configuration for nginx
[Definition]

mode = aggressive

mdre-modsec = ^\s*\[error\]\s+\d+#\d+:\s*\*\d+\s+\[client <HOST>\].*ModSecurity: Access denied with code 403.*

mdre-aggressive =  %(mdre-modsec)s

failregex = <mdre-<mode>>

ignoreregex =
datepattern = {^LN-BEG}
journalmatch = _SYSTEMD_UNIT=nginx.service + _COMM=nginx

Graylogger:

nginx_to_gelf.lua 
-- nginx_to_gelf.lua
-- This script ensures that a GELF-compliant "short_message" field is present.
-- You can extract additional fields (e.g. timestamp, log level) as needed.

function nginx_to_gelf(tag, timestamp, record)
    -- If the record does not have a 'short_message', use the 'log' field or a default message.
    if record["short_message"] == nil then
        if record["log"] ~= nil then
            record["short_message"] = record["log"]
        else
            record["short_message"] = "Nginx log entry"
        end
    end

    -- Optionally, you can map/change fields here.
    -- For example: extract a timestamp from the log line if needed,
    -- or add a static field to indicate the source.
    record["source"] = "nginx_error_log"

    -- Return the modified record (1 indicates success in this context)
    return 1, timestamp, record
end

